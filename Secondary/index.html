<!DOCTYPE html>
<html>

<head>
    <title>Secondary Application</title>
</head>

<body>
    <h1>Secondary Application</h1>
    <div id="chatBox"></div>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendMessageButton">Send</button>

    <br /><br />
    <button id="launchButtonPrimary">Launch Primary</button>
    <button id="launchButtonSecondary">Launch Secondary</button>

    <script type="module" src="../Shared/SharedWorkerMessageTypes.js"></script>
    <script type="module" src="../Shared/AppURLs.js"></script>
    <script type="module">
        import { MESSAGE_TYPES } from '../Shared/SharedWorkerMessageTypes.js';
        import { AppURLs } from '../Shared/AppURLs.js';

        const sharedWorker = new SharedWorker('../Shared/sharedWorker.js');
        const port = sharedWorker.port;
        const chatBox = document.getElementById('chatBox');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const launchP = document.getElementById('launchButtonPrimary');
        const launchS = document.getElementById('launchButtonSecondary');
        const INSTANCE = "SECONDARY";

        port.onmessage = function (event) {
            const data = event.data;

            if (data.type === MESSAGE_TYPES.LOG) {
                console.log(data.message);
                return;
            }

            if (data.message) {
                // Handle chat messages
                const message = data.message;
                chatBox.innerHTML += `<p>${message}</p>`;
            }

            if (data.connections) {
                // Log the list of connected ports (windows/tabs) to the console
                console.log('Connected ports:', data.connections);
            }
        };

        sendMessageButton.addEventListener('click', function () {
            const message = INSTANCE + ": " + messageInput.value;
            if (message.trim() !== '') {
                // Send the message to the SharedWorker
                port.postMessage({ type: MESSAGE_TYPES.MESSAGE, message: message });
                // Display sent messages in the chatBox
                chatBox.innerHTML += `<p>${message}</p>`;
                // Clear the input field
                messageInput.value = '';
            }
        });

        launchP.addEventListener('click', function () {
            const url = AppURLs["PRIMARY"];
            const windowName = 'MyPopupWindow'; // Unique name for the popup window.
            const windowFeatures = 'scrollbars=yes,modal=yes,width=400,height=400'; // Customize window features.

            const newWindow = window.open(url, windowName, windowFeatures);
        });

        launchS.addEventListener('click', function () {
            const url = AppURLs["SECONDARY"];
            const windowFeatures = 'scrollbars=yes,modal=yes,width=400,height=400'; // Customize window features.
            const timestamp = new Date().getTime();
            const newWindow = window.open(url, `${timestamp}`, windowFeatures);
        });

        window.addEventListener('beforeunload', function () {
            port.postMessage({ type: MESSAGE_TYPES.CLOSE, command: 'closing' });
        });

    </script>
</body>

</html>